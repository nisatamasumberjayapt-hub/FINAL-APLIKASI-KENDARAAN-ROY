<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login - PT ANISA JAYA UTAMA</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  *{box-sizing:border-box;font-family:'Poppins',sans-serif}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#f1f6ff 0%,#dbe7ff 100%);display:flex;align-items:center;justify-content:center}

  /* Card login (tetap seperti sebelumnya) */
  .card{
    background:rgba(255,255,255,0.95);
    border-radius:18px;
    box-shadow:0 8px 25px rgba(0,0,0,0.08),0 0 12px rgba(0,100,255,0.06);
    padding:36px 30px;width:min(92vw,380px);text-align:center;position:relative;
    z-index:10;
  }
  h2{font-size:22px;margin:0 0 6px;color:#1b1b1b;text-transform:uppercase;font-weight:600;letter-spacing:1px}
  h2::before{content:"‚ù§Ô∏è";margin-right:6px;display:inline-block;animation:beat 1.3s infinite}
  @keyframes beat{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
  .subtitle{color:#444;margin-bottom:18px}
  .input-group{position:relative;margin-bottom:14px}
  input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #ccd6ee;font-size:14px}
  input:focus{outline:none;box-shadow:0 0 8px rgba(43,124,255,0.16);border-color:#2b7cff}
  .toggle-pass{position:absolute;right:10px;top:10px;cursor:pointer}
  #btnLogin{width:100%;padding:12px;border-radius:10px;border:0;background:#1b6e2a;color:#fff;font-weight:700;box-shadow:0 3px 8px rgba(27,110,42,0.25);cursor:pointer}
  #btnLogin:hover{background:#13561f}
  p a{color:#1b6e2a;text-decoration:none}

  /* ---- OVERLAY SCENE ---- */
  #loadingOverlay{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,251,255,0.98));
    z-index:999;overflow:hidden;
  }

  .scene-wrap{position:relative;width:100%;max-width:920px;height:70vh;display:flex;align-items:center;justify-content:center;pointer-events:none}
  /* portal (oval minimalis) */
  .portal{
    position:absolute;right:calc(50% - 40px); /* portal agak ke depan/middle */
    top:50%;
    transform:translate(40%, -20%);
    width:180px;height:220px;border-radius:50% / 60%;
    background: radial-gradient(circle at 50% 40%, rgba(173,216,255,0.9), rgba(173,216,255,0.65));
    box-shadow:0 8px 24px rgba(60,150,255,0.12), inset 0 -6px 18px rgba(255,255,255,0.2);
    display:flex;align-items:center;justify-content:center;
    z-index:50;
  }
  .portal::after{
    content:"";position:absolute;inset:6px;border-radius:50%/60%;box-shadow:0 0 0 6px rgba(173,216,255,0.08) inset;
  }

  /* big monkey (center) */
  #monkeyBig{
    width:300px;max-width:42vw;transition:transform .35s ease;z-index:45;
    animation:breath 3s ease-in-out infinite;
    transform-origin:center;
  }
  @keyframes breath{0%{transform:translateY(0) scale(1)}50%{transform:translateY(-6px) scale(1.02)}100%{transform:translateY(0) scale(1)}}

  /* small road under motor */
  .road{
    position:absolute;bottom:24vh;left:6%;right:6%;height:8px;background:linear-gradient(90deg,#f0f3f8,#e9eef8);
    border-radius:6px;box-shadow:inset 0 -2px 6px rgba(0,0,0,0.03);z-index:30;opacity:0.95;
  }
  .road::before{
    content:"";position:absolute;left:5%;right:5%;top:0;height:100%;background:repeating-linear-gradient(90deg, rgba(0,0,0,0.03) 0 8px, transparent 8px 20px);border-radius:6px;
    opacity:0.25;
  }

  /* motor group: image + label; positioned initially not at the far left (start slightly inwards) */
  .motor-group{
    position:absolute;bottom:calc(24vh - 18px);left:6%;display:flex;align-items:center;gap:8px;z-index:40;
    transform:translateX(0);
    pointer-events:none;
  }
  .motor-group img{width:96px;height:auto;display:block;filter:drop-shadow(0 8px 16px rgba(0,0,0,0.12))}
  .motor-label{font-weight:600;color:#004aad;font-size:15px;white-space:nowrap}

  /* drive animation (moves motor to near-portal) */
  .driving{animation:driveLinear var(--drive-duration, 4.2s) linear forwards}
  @keyframes driveLinear{
    0%{transform:translateX(0) scale(1)}
    70%{transform:translateX(calc(40vw)) scale(1)}
    85%{transform:translateX(calc(42vw)) scale(1)}
    100%{transform:translateX(calc(44vw)) scale(1)}
  }

  /* enter portal (on success) - motor moves a bit more and shrinks and fades */
  .enter-portal{
    animation:enterPortal 1.2s ease forwards;
  }
  @keyframes enterPortal{
    0%{transform:translateX(calc(44vw)) scale(1);opacity:1}
    50%{transform:translateX(calc(45vw)) scale(.85);opacity:1}
    100%{transform:translateX(calc(46vw)) scale(.35);opacity:0}
  }

  /* broken (on fail) - shake + smoke */
  .broken{animation:shake .9s ease-in-out 0s 2}
  @keyframes shake{
    0%{transform:translateX(calc(44vw)) rotate(0deg)}
    25%{transform:translateX(calc(44vw)) rotate(-6deg)}
    50%{transform:translateX(calc(44vw)) rotate(6deg)}
    75%{transform:translateX(calc(44vw)) rotate(-4deg)}
    100%{transform:translateX(calc(44vw)) rotate(0deg)}
  }

  /* smoke (hidden by default, shown when broken) */
  .smoke{
    position:absolute;right:calc(56% - 40px);bottom:calc(24vh + 18px);
    width:18px;height:18px;border-radius:50%;background:rgba(120,120,120,0.18);filter:blur(1px);
    opacity:0;transform:translateY(0);
  }
  .smoke.s1{animation:smokeUp1 1.2s ease forwards}
  .smoke.s2{animation:smokeUp2 1.4s ease forwards}
  @keyframes smokeUp1{0%{opacity:0;transform:translateY(0) scale(0.6)}30%{opacity:0.9}100%{opacity:0;transform:translateY(-40px) scale(1.2)}}
  @keyframes smokeUp2{0%{opacity:0;transform:translateY(0) scale(0.7)}20%{opacity:0.85}100%{opacity:0;transform:translateY(-54px) scale(1.4)}}

  /* text */
  .loading-text{position:absolute;top:20%;left:50%;transform:translateX(-50%);text-align:center;color:#003a8c;font-size:18px;line-height:1.25;z-index:46;pointer-events:none}
  .loading-sub{position:absolute;top:calc(20% + 70px);left:50%;transform:translateX(-50%);color:#0050a0;font-size:15px;font-weight:600;z-index:46;pointer-events:none;opacity:1;transition:opacity .4s ease}

  /* fade overlay */
  .overlay-fade{animation:overlayFade 0.9s ease forwards}
  @keyframes overlayFade{from{opacity:1}to{opacity:0}}

  /* small responsive adjustments */
  @media (max-width:600px){
    #monkeyBig{width:220px}
    .portal{width:140px;height:170px}
    .motor-group img{width:78px}
    .road{bottom:22vh}
    .smoke{right:40%}
  }
</style>
</head>
<body>

<!-- LOGIN CARD (no changes to structure) -->
<div class="card" id="loginCard">
  <h2>PT ANISA JAYA UTAMA</h2>
  <div class="subtitle">Login Pengguna</div>

  <div class="input-group">
    <input type="text" id="username" placeholder="Username" />
  </div>
  <div class="input-group">
    <input type="password" id="password" placeholder="Password" />
    <span class="toggle-pass" id="togglePass">üëÅÔ∏è</span>
  </div>

  <button id="btnLogin">Masuk</button>
  <p style="margin-top:10px;">Belum punya akun? <a href="register.html">Daftar di sini</a></p>
</div>

<!-- LOADING OVERLAY SCENE -->
<div id="loadingOverlay" aria-hidden="true">
  <div class="scene-wrap" id="sceneWrap">
    <div class="portal" id="portal"></div>

    <!-- big monkey (center) -->
    <img id="monkeyBig" src="assets/monyet_mikir.png" alt="monyet mikir">

    <!-- road line -->
    <div class="road" aria-hidden="true"></div>

    <!-- motor group (image + label). Starts near left (left set in CSS). -->
    <div class="motor-group" id="motorGroup" aria-hidden="true">
      <img id="motorImg" src="assets/monyet_motor.png" alt="monyet naik motor">
      <div class="motor-label" id="motorLabel">kamu otw üëâ</div>
    </div>

    <!-- smoke placeholders -->
    <div class="smoke" id="smoke1" style="opacity:0"></div>
    <div class="smoke" id="smoke2" style="opacity:0"></div>
  </div>

  <!-- texts -->
  <div class="loading-text" id="loadingText">üêµ Monyet lagi mikir...<br>Apakah kamu orang yang tepat...?</div>
  <div class="loading-sub" id="loadingSub">kamu otw üëâ</div>
</div>

<script>
  // DOM
  const btn = document.getElementById('btnLogin');
  const toggle = document.getElementById('togglePass');
  const pass = document.getElementById('password');
  const card = document.getElementById('loginCard');

  const overlay = document.getElementById('loadingOverlay');
  const motorGroup = document.getElementById('motorGroup');
  const motorImg = document.getElementById('motorImg');
  const monkeyBig = document.getElementById('monkeyBig');
  const loadingText = document.getElementById('loadingText');
  const loadingSub = document.getElementById('loadingSub');
  const smoke1 = document.getElementById('smoke1');
  const smoke2 = document.getElementById('smoke2');
  const portal = document.getElementById('portal');

  // API URL (sama seperti sebelumnya)
  const API_URL = "https://script.google.com/macros/s/AKfycbwAH7TUpCMajOE3Mtuz0ELcsXVurKQkFz2e5vPVVf4IT4JPHhoErMvO9A-i0A4cGB4q/exec";

  // helper api (small wrapper)
  async function api(action, payload = {}) {
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, ...payload })
      });
      return await res.json();
    } catch (e) {
      return { success: false };
    }
  }

  function setSession(u){ try{ localStorage.setItem("aj_user", JSON.stringify(u)); }catch(e){} }

  // toggle pass visibility
  toggle.addEventListener('click', ()=> {
    pass.type = pass.type === 'password' ? 'text' : 'password';
    toggle.textContent = pass.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
  });

  // start driving animation (applies driving class)
  function startDrive(){
    // ensure not stacked classes
    motorGroup.classList.remove('broken','enter-portal');
    void motorGroup.offsetWidth;
    // set CSS var for speed if needed
    motorGroup.style.setProperty('--drive-duration','4.2s');
    motorGroup.classList.add('driving');
    // show small label below as well
    loadingSub.style.opacity = '1';
  }

  // stop drive
  function stopDrive(){
    motorGroup.classList.remove('driving');
  }

  // handle success: enter portal sequence
  function handleSuccess(user){
    // change big monkey expression
    monkeyBig.src = 'assets/monyet_senang.png';
    loadingText.innerHTML = '‚úÖ Monyet yakin kamu orang yang benar! üöóüí®';
    // fade out loading text slowly to focus on portal entrance
    loadingText.style.transition = 'opacity .6s ease';
    loadingText.style.opacity = '0.9';

    // speed up slightly and then enter portal
    motorGroup.classList.remove('driving');
    // push motor near portal position quickly then enter
    motorGroup.style.setProperty('--drive-duration','0.9s');
    motorGroup.classList.add('enter-portal');

    // hide small label while entering
    loadingSub.style.opacity = '0';

    // fade overlay after portal animation completes
    setTimeout(()=> {
      overlay.classList.add('overlay-fade');
    }, 1100);

    // after fade, set session and redirect
    setTimeout(()=> {
      try{ setSession(user); }catch(e){}
      window.location.href = 'dashboard.html';
    }, 1400);
  }

  // handle fail: broken motor + smoke then restore form
  function handleFail(){
    monkeyBig.src = 'assets/monyet_salah.png';
    loadingText.innerHTML = 'üôà Monyet berhenti mikir... salah orang!';
    // stop drive and play broken
    motorGroup.classList.remove('driving');
    void motorGroup.offsetWidth;
    // put motor to approx mid (if not there)
    motorGroup.style.transform = 'translateX(calc(44vw))';
    motorGroup.classList.add('broken');

    // show smoke elements
    smoke1.style.opacity = '1';
    smoke2.style.opacity = '1';
    smoke1.classList.add('s1');
    smoke2.classList.add('s2');

    // hide label
    loadingSub.style.opacity = '0';

    // after broken animation, hide overlay & restore form
    setTimeout(()=> {
      // clean up smoke & classes
      smoke1.classList.remove('s1');
      smoke2.classList.remove('s2');
      smoke1.style.opacity = '0';
      smoke2.style.opacity = '0';
      motorGroup.classList.remove('broken','driving');
      overlay.style.display = 'none';
      card.style.display = 'block';
    }, 2200);
  }

  // show overlay and start anim
  function showOverlay(){
    card.style.display = 'none';
    overlay.style.display = 'flex';
    // reset states
    overlay.classList.remove('overlay-fade');
    motorGroup.classList.remove('driving','enter-portal','broken');
    motorGroup.style.transform = 'translateX(0)';
    loadingText.style.opacity = '1';
    loadingSub.style.opacity = '1';
    monkeyBig.src = 'assets/monyet_mikir.png';
    loadingText.innerHTML = 'üêµ Monyet lagi mikir...<br>Apakah kamu orang yang tepat...?';
    // small delay then start motor drive
    setTimeout(()=> startDrive(), 120);
  }

  // main login handler
  btn.addEventListener('click', async ()=>{
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    if(!username || !password) return alert('Isi username dan password!');
    showOverlay();

    // call api
    try{
      const res = await api('login',{ username, password });
      if(res && res.success){
        // wait small time so motor is already visible and moving -> then success sequence
        setTimeout(()=> handleSuccess(res.user), 900);
      } else {
        // if fail, wait until motor reaches mid then broken
        setTimeout(()=> handleFail(), 1300);
      }
    }catch(e){
      // network error
      setTimeout(()=> {
        monkeyBig.src = 'assets/monyet_salah.png';
        loadingText.innerHTML = '‚ö†Ô∏è Server error, coba lagi nanti!';
        setTimeout(()=> { overlay.style.display='none'; card.style.display='block'; }, 2000);
      }, 800);
    }
  });
</script>
</body>
</html>
