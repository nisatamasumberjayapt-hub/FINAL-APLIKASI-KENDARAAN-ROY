<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manajemen User | PT ANISA JAYA UTAMA ‚Äî BY ROY</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { font-family: "Poppins", sans-serif; background:#f6f9f6; margin:0; color:#123; }
    header { background:#0c5d27; color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
    header nav a { color:#fff; text-decoration:none; margin-left:16px; font-weight:500; }
    header .user-info { display:flex; align-items:center; gap:8px; font-weight:600; }
    main { max-width:1300px; margin:28px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns:370px 1fr; gap:24px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.08); padding:20px; }

    h2 { margin-top:0; color:#0b4d1b; text-align:center; text-transform:uppercase; }
    label { display:block; font-weight:600; font-size:14px; margin:8px 0 4px; color:#0c5d27; }
    input, select { width:100%; padding:9px 12px; border:1.4px solid #cdd9cd; border-radius:8px; }
    input:focus, select:focus { outline:none; border-color:#0c5d27; box-shadow:0 0 4px rgba(12,93,39,.3); }

    .username-row { display:flex; align-items:center; gap:6px; }
    #usernameWarning { color:#c0392b; font-size:13px; display:none; font-weight:600; }

    .row-btn { display:flex; gap:10px; margin-top:14px; justify-content:center; }
    .btn { border:none; border-radius:8px; padding:10px 14px; font-weight:700; cursor:pointer; transition:0.2s; }
    .btn-primary { background:#0c5d27; color:#fff; }
    .btn-primary:hover { background:#137c36; }
    .btn-cancel { background:#f1f1f1; color:#333; }
    .btn-cancel:hover:not(:disabled) { background:#ddd; }
    .btn-cancel:disabled { opacity:.5; cursor:not-allowed; }

    .toolbar { display:flex; align-items:center; gap:6px; margin-bottom:12px; }
    #searchUser { flex:1; padding:10px 12px; border:1.5px solid #cdd9cd; border-radius:8px; }
    #clearUserSearch { display:none; padding:6px 10px; border:none; border-radius:6px; background:#c0392b; color:#fff; cursor:pointer; }

    table { width:100%; border-collapse:collapse; font-size:14px; table-layout:auto; }
    th, td { padding:10px 14px; border-bottom:1px solid #e0ebe0; vertical-align:top; }
    thead th { background:#0c5d27; color:#fff; text-align:left; }
    tbody tr:hover { background:#f6fbf6; }

    .btn-sm { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-size:13px; }
    .btn-edit { background:#f1c40f; color:#000; }
    .btn-delete { background:#c0392b; color:#fff; }

    .avatar { font-size:28px; margin-right:4px; }
  </style>
</head>

<body onload="initUserPage()">
  <header>
    <div><strong>üë• PT ANISA JAYA UTAMA ‚Äî BY ROY</strong></div>
    <div class="user-info" id="userInfo"></div>
    <nav>
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="kendaraan.html">üöó Kendaraan</a>
      <a href="#" onclick="logout()">üîí Logout</a>
    </nav>
  </header>

  <main>
    <div class="grid">
      <!-- FORM -->
      <section class="card">
        <h2>üßæ FORM USER</h2>

        <label>Username</label>
        <div class="username-row">
          <input type="text" id="username" placeholder="username unik" />
          <span id="usernameWarning">‚ö†Ô∏è Sudah digunakan!</span>
        </div>

        <label>Password</label>
        <input type="text" id="password" placeholder="password" />

        <label>Role</label>
        <select id="role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>

        <label>Nama Lengkap</label>
        <input type="text" id="nama" placeholder="nama lengkap" />

        <div class="row-btn">
          <button id="btnSave" class="btn btn-primary">üíæ Simpan</button>
          <button id="btnCancel" class="btn btn-cancel" disabled>‚ùå Batal</button>
        </div>
      </section>

      <!-- TABLE -->
      <section class="card">
        <h2>üìã DAFTAR USER</h2>
        <div class="toolbar">
          <input id="searchUser" type="text" placeholder="üîç Cari user / nama..." />
          <button id="clearUserSearch">‚ùå</button>
        </div>

        <table id="tblUsers">
          <thead>
            <tr>
              <th>AVATAR</th>
              <th>USERNAME</th>
              <th>ROLE</th>
              <th>NAMA</th>
              <th>AKSI</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="5" align="center">Memuat data...</td></tr></tbody>
        </table>
      </section>
    </div>
  </main>

  <script src="main.js?v=7.5"></script>
  <script>
    let USER_DATA = [];
    let USER_MODE = "add";
    let USER_EDIT_OLD = "";

    const $ = id => document.getElementById(id);
    const EMOJIS = ["üêµ","üê∂","üê±","ü¶ä","üê∞","üêº","üêØ","üêÆ","üê∏","üêô","üêß","ü¶â","üê®","üêπ","ü¶Ñ"];

    function getAvatar(username){
      // selalu pilih emoji tetap berdasarkan hash username
      const hash = Array.from(username).reduce((a,c)=>a+c.charCodeAt(0),0);
      return EMOJIS[hash % EMOJIS.length];
    }

    async function reloadUserList(){
      const res = await api("getUsers");
      const tbody = $("tblUsers").querySelector("tbody");
      if(!res.success || !Array.isArray(res.data)){
        tbody.innerHTML = `<tr><td colspan="5" align="center">Gagal memuat data</td></tr>`;
        return;
      }
      USER_DATA = res.data;
      renderUserTable(USER_DATA);
    }

    function renderUserTable(rows){
      const tbody = $("tblUsers").querySelector("tbody");
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="5" align="center">Tidak ada data</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map(u => `
        <tr>
          <td><span class="avatar">${getAvatar(u.username)}</span></td>
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td>${u.nama}</td>
          <td>
            <button class="btn-sm btn-edit" onclick="editUser('${u.username}')">‚úèÔ∏è Edit</button>
            <button class="btn-sm btn-delete" onclick="deleteUser('${u.username}')">üóëÔ∏è Hapus</button>
          </td>
        </tr>
      `).join("");
    }

    async function saveUser(){
      const username = $("username").value.trim();
      const password = $("password").value.trim();
      const role = $("role").value;
      const nama = $("nama").value.trim();

      if(!username || !password || !role || !nama)
        return toast("Semua kolom wajib diisi!");

      // cek duplikat username saat tambah
      if(USER_MODE==="add" && USER_DATA.some(u=>u.username.toLowerCase()===username.toLowerCase())){
        $("usernameWarning").style.display="inline";
        return;
      }

      if(USER_MODE==="add"){
        const res = await api("register",{username,password,nama});
        toast(res.message);
      }else{
        const res = await api("updateUser",{oldUsername:USER_EDIT_OLD,username,password,role,nama});
        toast(res.message);
      }

      await reloadUserList();
      resetForm();
    }

    function editUser(username){
      const u = USER_DATA.find(x=>x.username===username);
      if(!u) return toast("User tidak ditemukan!");

      USER_MODE="edit";
      USER_EDIT_OLD=username;
      $("username").value=u.username;
      $("username").setAttribute("disabled","disabled");
      $("password").value=u.password||"";
      $("role").value=u.role;
      $("nama").value=u.nama;
      $("btnCancel").disabled=false;
      $("btnSave").textContent="‚úÖ Update";
    }

    async function deleteUser(username){
      if(!confirm(`Hapus user '${username}'?`)) return;
      const res = await api("deleteUser",{username});
      toast(res.message);
      await reloadUserList();
    }

    function resetForm(){
      USER_MODE="add";
      USER_EDIT_OLD="";
      $("username").removeAttribute("disabled");
      ["username","password","nama"].forEach(id=>$(`${id}`).value="");
      $("role").value="user";
      $("btnCancel").disabled=true;
      $("btnSave").textContent="üíæ Simpan";
      $("usernameWarning").style.display="none";
    }

    function initSearchUser(){
      const input=$("searchUser");
      const clearBtn=$("clearUserSearch");
      input.addEventListener("input",()=>{
        const val=input.value.toLowerCase();
        const filtered=USER_DATA.filter(u=>u.username.toLowerCase().includes(val)||u.nama.toLowerCase().includes(val));
        renderUserTable(filtered);
        clearBtn.style.display=val?"inline-block":"none";
      });
      clearBtn.addEventListener("click",()=>{input.value="";input.dispatchEvent(new Event("input"));});
    }

    async function initUserPage(){
      const user=getSession();
      if(!user){location.href="login.html";return;}
      if(user.role!=="admin"){
        toast("üö´ Hanya admin yang bisa mengakses halaman ini!");
        setTimeout(()=>location.href="dashboard.html",1500);
        return;
      }

      // tampilkan info login
      $("userInfo").innerHTML = `${getAvatar(user.username)} ${user.nama} (${user.role})`;

      $("btnSave").addEventListener("click",saveUser);
      $("btnCancel").addEventListener("click",resetForm);
      $("username").addEventListener("input",()=>{
        const val=$("username").value.trim().toLowerCase();
        $("usernameWarning").style.display=USER_DATA.some(u=>u.username.toLowerCase()===val)?"inline":"none";
      });
      initSearchUser();
      await reloadUserList();
    }
  </script>
</body>
</html>
