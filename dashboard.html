<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ  Dashboard | PT Anisa Jaya Utama</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>ğŸ¢ PT Anisa Jaya Utama â€” <small>by Roy</small></h1>
    <nav>
      <a href="dashboard.html" class="active">ğŸ  Dashboard</a>
      <a href="kendaraan.html">ğŸš™ Kendaraan</a>
      <a href="#">ğŸ‘¤ User</a>
      <a href="#" onclick="logout()">ğŸ”’ Logout</a>
    </nav>
  </header>

  <main class="dashboard-container">
    <section class="dashboard-box">
      <h2>ğŸ“Š Daftar Kendaraan</h2>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ğŸ” Cari kendaraan (Plat / Letak)">
        <button id="clearSearch" class="btn-clear" title="Hapus pencarian">âŒ</button>
      </div>

      <table id="tblKendaraan">
        <thead>
          <tr>
            <th>ğŸš— Plat Nomor</th>
            <th>ğŸ“ Letak</th>
            <th>ğŸ§¾ STNK</th>
            <th>ğŸ”§ KIR</th>
            <th>ğŸ›  Servis Terakhir</th>
            <th>ğŸ’° Pajak 5 Tahunan</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="legend">
        <span class="dot green"></span> Aman
        <span class="dot yellow"></span> Peringatan (â‰¤10 hari / Servis â‰¥3 bulan)
        <span class="dot red"></span> Lewat (STNK/KIR/Pajak habis)
      </div>
    </section>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwAH7TUpCMajOE3Mtuz0ELcsXVurKQkFz2e5vPVVf4IT4JPHhoErMvO9A-i0A4cGB4q/exec";

    async function api(action, payload = {}) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "text/plain;charset=utf-8"},
        body: JSON.stringify({action, ...payload})
      });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return {}; }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("clearSearch").onclick = clearSearch;
      document.getElementById("searchInput").oninput = applySearch;
      loadData();
    });

    function clearSearch() {
      document.getElementById("searchInput").value = "";
      applySearch();
    }

    function applySearch() {
      const val = document.getElementById("searchInput").value.toLowerCase();
      document.getElementById("clearSearch").style.display = val ? "inline-block" : "none";
      document.querySelectorAll("#tblKendaraan tbody tr").forEach(tr => {
        const plat = tr.cells[0].innerText.toLowerCase();
        const letak = tr.cells[1].innerText.toLowerCase();
        tr.style.display = plat.includes(val) || letak.includes(val) ? "" : "none";
      });
    }

    async function loadData() {
      const tbody = document.querySelector("#tblKendaraan tbody");
      tbody.innerHTML = "<tr><td colspan='6' align='center'>â³ Memuat data...</td></tr>";

      const res = await api("getKendaraan");
      if (!res.success) {
        tbody.innerHTML = "<tr><td colspan='6' align='center'>âŒ Gagal memuat data</td></tr>";
        return;
      }

      const data = res.data.sort((a, b) => a.Platnomor.localeCompare(b.Platnomor));
      tbody.innerHTML = data.map(k => `
        <tr>
          <td>${k.Platnomor}</td>
          <td>${k.Letak}</td>
          <td>${k.STNK ? k.STNK.split("T")[0] : "-"}</td>
          <td>${k.KIR ? k.KIR.split("T")[0] : "-"}</td>
          <td>${k.ServisTerakhir ? k.ServisTerakhir.split("T")[0] : "-"}</td>
          <td>${k.pajak5tahun ? k.pajak5tahun.split("T")[0] : "-"}</td>
        </tr>
      `).join("");
    }

    function logout() {
      localStorage.removeItem("aj_user");
      location.href = "login.html";
    }
  </script>
</body>
</html>
