<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kendaraan | PT ANISA JAYA UTAMA â€” BY ROY</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .kendaraan-wrapper {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 2%;
      margin: 30px auto;
      width: 95%;
      max-width: 1400px;
    }

    .form-container {
      flex: 0 0 27%;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .form-container h2 {
      color: #0b4d1b;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-container label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      color: #0b4d1b;
    }

    .form-container input {
      width: 100%;
      padding: 9px 10px;
      border: 1.5px solid #ccc;
      border-radius: 6px;
      margin-top: 5px;
      font-size: 14px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    #btnPrimary, #btnCancel {
      flex: 1;
      padding: 10px;
      font-size: 15px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #btnPrimary { background: #0b4d1b; color: white; }
    #btnPrimary:hover { background: #097b20; }
    #btnCancel { background: #444; color: white; }
    #btnCancel[disabled] { opacity: 0.6; cursor: not-allowed; }

    .tabel-container {
      flex: 0 0 70%;
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .btn-edit {
      background: #0b4d1b;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-edit:hover { background: #107c2a; }
  </style>
</head>

<body>
  <header>
    <h1>ğŸš— PT ANISA JAYA UTAMA â€” BY ROY</h1>
    <nav>
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a href="user.html">ğŸ‘¤ User</a>
      <a href="login.html">ğŸ“„ Logout</a>
    </nav>
  </header>

  <main>
    <div class="kendaraan-wrapper">
      <!-- FORM -->
      <div class="form-container">
        <h2>ğŸš™ Tambah Kendaraan</h2>

        <label for="plat">Plat Nomor</label>
        <input type="text" id="plat" placeholder="Contoh: B1234XYZ" disabled>

        <label for="lokasi">Letak / Garasi</label>
        <input type="text" id="lokasi" placeholder="Contoh: Jakarta" disabled>

        <label for="stnk">STNK</label>
        <input type="date" id="stnk" disabled>

        <label for="kir">KIR</label>
        <input type="date" id="kir" disabled>

        <label for="servis">Servis Terakhir</label>
        <input type="date" id="servis" disabled>

        <label for="pajak">Pajak 5 Tahunan</label>
        <input type="date" id="pajak" disabled>

        <div class="form-actions">
          <button id="btnPrimary">â• Tambah</button>
          <button id="btnCancel" disabled>âœ– Batal</button>
        </div>
      </div>

      <!-- TABEL -->
      <div class="tabel-container">
        <h2>ğŸ“‹ Daftar Kendaraan</h2>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="ğŸ” Cari kendaraan (Plat Nomor / Letak)">
        </div>

        <div class="table-wrapper">
          <table id="tblKendaraan">
            <thead>
              <tr>
                <th>Plat Nomor</th>
                <th>Letak</th>
                <th>STNK</th>
                <th>KIR</th>
                <th>Servis Terakhir</th>
                <th>Pajak 5 Tahunan</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="kendaraanBody">
              <tr><td colspan="7" align="center">Memuat data kendaraan...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="legend">
          ğŸŸ© Aman | ğŸŸ¨ Peringatan (â‰¤10 hari / Servis â‰¥3 bulan) | ğŸŸ¥ Lewat (STNK/KIR/Pajak habis)
        </div>
      </div>
    </div>
  </main>

  <script src="main.js?v=20251109-final3"></script>

  <script>
    /* ===== FORM MODE SYSTEM ===== */
    let mode = "view"; // view | add | edit
    let editData = null;
    const ids = ["plat", "lokasi", "stnk", "kir", "servis", "pajak"];

    function setForm(enabled) {
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.disabled = !enabled;
      });
    }

    function clearForm() {
      ids.forEach(id => document.getElementById(id).value = "");
    }

    function setButtonState() {
      const btnAdd = document.getElementById("btnPrimary");
      const btnCancel = document.getElementById("btnCancel");
      if (mode === "view") {
        btnAdd.textContent = "â• Tambah";
        btnCancel.disabled = true;
      } else if (mode === "add") {
        btnAdd.textContent = "ğŸ’¾ Simpan";
        btnCancel.disabled = false;
      } else if (mode === "edit") {
        btnAdd.textContent = "âœ… Update";
        btnCancel.disabled = false;
      }
    }

    function enterViewMode() {
      mode = "view";
      clearForm();
      setForm(false);
      setButtonState();
    }

    function enterAddMode() {
      mode = "add";
      clearForm();
      setForm(true);
      setButtonState();
      document.getElementById("plat").focus();
    }

    function enterEditMode(row) {
      mode = "edit";
      setForm(true);
      setButtonState();

      document.getElementById("plat").value = row.Platnomor || "";
      document.getElementById("lokasi").value = row.Letak || "";
      document.getElementById("stnk").value = row.STNK?.split("T")[0] || "";
      document.getElementById("kir").value = row.KIR?.split("T")[0] || "";
      document.getElementById("servis").value = row.ServisTerakhir?.split("T")[0] || "";
      document.getElementById("pajak").value = row.pajak5tahun?.split("T")[0] || "";

      document.getElementById("plat").disabled = true; // kunci plat saat edit
      editData = row;
    }

    async function reloadTable() {
      const res = await api("getKendaraan");
      if (res && res.success) {
        const tbody = document.getElementById("kendaraanBody");
        tbody.innerHTML = "";
        res.data.forEach(k => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${k.Platnomor}</td>
            <td>${k.Letak}</td>
            <td>${k.STNK?.split("T")[0] || ""}</td>
            <td>${k.KIR?.split("T")[0] || ""}</td>
            <td>${k.ServisTerakhir?.split("T")[0] || ""}</td>
            <td>${k.pajak5tahun?.split("T")[0] || ""}</td>
            <td><button class="btn-edit" onclick='enterEditMode(${JSON.stringify(k)})'>âœï¸ Edit</button></td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

    document.getElementById("btnPrimary").addEventListener("click", async () => {
      if (mode === "view") return enterAddMode();

      const plat = document.getElementById("plat").value.trim();
      const lokasi = document.getElementById("lokasi").value.trim();
      const stnk = document.getElementById("stnk").value;
      const kir = document.getElementById("kir").value;
      const servis = document.getElementById("servis").value;
      const pajak = document.getElementById("pajak").value;

      if (!plat || !lokasi || !stnk || !kir || !servis || !pajak) {
        alert("âš ï¸ Semua kolom wajib diisi!");
        return;
      }

      const data = { Platnomor: plat, Letak: lokasi, STNK: stnk, KIR: kir, ServisTerakhir: servis, pajak5tahun: pajak };

      if (mode === "add") {
        const r = await api("addKendaraan", data);
        alert(r.message || (r.success ? "âœ… Data tersimpan!" : "âŒ Gagal menyimpan"));
        if (r.success) await reloadTable();
        enterViewMode();
      } else if (mode === "edit") {
        const r = await api("updateKendaraan", { PlatnomorLama: editData.Platnomor, ...data });
        alert(r.message || (r.success ? "âœ… Data diperbarui!" : "âŒ Gagal update"));
        if (r.success) await reloadTable();
        enterViewMode();
      }
    });

    document.getElementById("btnCancel").addEventListener("click", enterViewMode);

    window.onload = async () => {
      enterViewMode();
      await reloadTable();
    };
  </script>
</body>
</html>
